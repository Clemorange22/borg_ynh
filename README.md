# Borg Backup for Yunohost

[![Latest Version](https://img.shields.io/badge/version-1.0.3-green.svg?style=flat)](https://github.com/YunoHost-Apps/borg_ynh/releases)
[![Status](https://img.shields.io/badge/status-testing-yellow.svg?style=flat)](https://github.com/YunoHost-Apps/borg_ynh/milestones)
[![Integration level](https://dash.yunohost.org/integration/borg.svg)](https://dash.yunohost.org/appci/app/borg)
[![GitHub license](https://img.shields.io/badge/license-GPLv3-blue.svg?style=flat)](https://raw.githubusercontent.com/YunoHost-Apps/borg_ynh/master/LICENSE)
[![GitHub issues](https://img.shields.io/github/issues/YunoHost-Apps/borg_ynh.svg?style=flat)](https://github.com/YunoHost-Apps/borg_ynh/issues)

[![Install Borg with YunoHost](https://install-app.yunohost.org/install-with-yunohost.png)](https://install-app.yunohost.org/?app=borg)

An experimental borg implementation for yunohost

## Usage

If you want to backup your Server A onto the Server B, you need:
* Domain name of server B: serverB.local
* Name of the user that will be created on server B and that server A will use to ssh on server B: servera
* YunoHost names of apps you want to backup
* Frequency of your backups, see below

## Setup Borg Backup App on Server A

Firstly set up the Borg Backup App (borg_ynh) on the server A you want to backup:

```
$ yunohost app install https://github.com/YunoHost-Apps/borg_ynh
Indicate the domain name of server B where to upload backups: serverB.local
Indicate the ssh user to use to connect on this server: servera
Indicate a strong passphrase, that you will keep preciously if you want to be able to use your backups: N0tAW3akp4ssw0rdYoloMacN!guets
Would you like to backup your YunoHost configuration ? [0 | 1] (default: 1):
Would you like to backup mails and user home directory ? [0 | 1] (default: 1):
Which apps would you backup (list separated by comma or 'all') ? (default: all):
Indicate the backup frequency (see systemd OnCalendar format) (default: Daily):
```
## Syntax to define backup frequency

You can schedule your backup by choosing an other frequency. Some example:

Monthly :

Weekly :

Daily : Daily at midnight

Hourly : Hourly o Clock

Sat *-*-1..7 18:00:00 : The first saturday of every month at 18:00

4:00 : Every day at 4 AM

5,17:00 : Every day at 5 AM and at 5 PM

See here for more info : https://wiki.archlinux.org/index.php/Systemd/Timers#Realtime_timer

## Information generated by borg_ynh

At the end of the installation, the app displays the public_key and the user to give to the person who has access to the server B.
```
You should now install the "Borg Server" app on serverb.local and fill questions like this:
User: servera
Public key: ssh-ed25519 AAAA[...] root@servera.local
```
This information is also sent by email to the admin of Server A.
If you don't find the mail and you don't see the message in the log bar you can find the public_key with this command:
```
$ cat /root/.ssh/id_borg_ed25519.pub
ssh-ed25519 AAAA[...] root@servera.local
```

## Setup Borg Server App on Server B

```
$ yunohost app install https://github.com/YunoHost-Apps/borgserver_ynh
Indicate the ssh user to create: servera
Indicate the public key given by borg_ynh app: ssh-ed25519 AAAA[...] root@servera.local
Indicate the storage quota: 5G
```

## Test
At this step your backup should run at the scheduled time. Note that the first backup can take very long, as many data have to be copied through ssh. Following backup are incremental, only additional data from to the last backup will be copied.

If you don't want to wait for the scheduled time, you can test to backup by running on Server A:
```
$ service borg start
```

Next you can check presence of your backup on Server B:
```
$ borg list /home/servera/backup
```

YOU SHOULD CHECK REGULARLY THAT YOUR BACKUP ARE STILL WORKING.

## Edit the apps list to backup

yunohost app setting borg apps -v "nextcloud,wordpress"

## Backup on different server, and apply distinct schedule for apps

You can setup the borg apps several times on the same server so you can backup on several server or manage your backup frequency differently for specific part of your server.
